# Civic Setu API Contract

This document captures the shared contract between the backend and the admin/mobile clients. All endpoints are served under the `/api` prefix. Unless stated otherwise, request and response bodies use JSON and timestamps are returned as ISO-8601 strings.

## Authentication

Most routes require a bearer token generated by the Auth service.

```
Authorization: Bearer <access_token>
```

### `POST /auth/register`
- Body includes `name`, `email`, `phone`, `password`, optional `role`, `department`, `language`
- Returns newly created user payload and token pair as in login

### `POST /auth/login`
- Body: `{ "emailOrPhone": string, "password": string }`
- Success: `200 OK`
```
{
  "success": true,
  "message": "Login successful",
  "data": {
    "user": { ...userFields },
    "token": "jwt-access-token",
    "refreshToken": "jwt-refresh-token"
  }
}
```
- Failure codes: `400` (validation), `401` (invalid credentials or deactivated account)

### `POST /auth/logout`
- Requires bearer token
- Returns `200 OK` with `{ success: true, message }`

### `POST /auth/refresh`
- Body: `{ "refreshToken": string }`
- Success: new token pair, same payload shape as login
- Failure: `400` (missing token), `401` (invalid or expired refresh token)

### `GET /auth/me`
- Requires bearer token
- Returns current user profile

### `PUT /auth/updateprofile`
- Requires bearer token
- Body: partial user profile fields (name, phone, address, language, profilePicture)
- Returns updated profile

### `PUT /auth/updatepassword`
- Requires bearer token
- Body: `{ currentPassword, newPassword }`
- Returns updated profile and success message

### `POST /auth/forgotpassword`
- Body: `{ emailOrPhone }`
- Returns reset token for use in `/auth/resetpassword/:resettoken`

### `PUT /auth/resetpassword/:resettoken`
- Body: `{ password }`
- Returns new access token upon success

### `POST /auth/verify/:token`
- Verifies a user's email address

## Reports

Report objects include these key fields:
- `_id`: Mongo ObjectId
- `title`, `description`, `category`, `priority`, `status`
- `category` enumerations: `road_issue`, `water_supply`, `electricity`, `garbage`, `drainage`, `street_light`, `traffic`, `pollution`, `encroachment`, `other`
- `status` enumerations: `submitted`, `acknowledged`, `assigned`, `in_progress`, `resolved`, `rejected`, `closed`
- `location`: `{ address, locality, ward, city, pincode, latitude, longitude }`
- `media`: array of media objects populated with `{ _id, url, type }`
- `assignedTo`, `assignedBy`, `assignedAt`, `department`
- `statusHistory`: chronological list of `{ status, changedBy, changedAt, comment }`
- `comments`: citizen and staff comments with `isInternal` flag
- `feedback`: citizen feedback after resolution

Pagination parameters follow the pattern `page` (1-based) and `limit` (default 10).

### `GET /reports`
- Query params: `page`, `limit`, `status`, `category`, `priority`, `department`, `sortBy`, `order`
- Returns `{ success, data: Report[], total }`
- Available without auth; bearer token unlocks personalized context when present

### `GET /reports/my-reports`
- Requires bearer token
- Returns reports created by the authenticated user

### `GET /reports/:id`
- Optional auth; if supplied, middleware attaches `req.user`
- Returns populated report or `404`

### `POST /reports`
- Requires bearer token
- Multipart form with `media` files (up to 5) and JSON fields described above
- On success returns created report populated with reporter and media references
- Validation failures return `400` with `errors` array from express-validator

### `PUT /reports/:id`
- Requires bearer token and ownership/admin privileges
- Body: report fields to update
- Returns updated report

### `DELETE /reports/:id`
- Requires bearer token and ownership/admin privileges
- Soft-deletes the report (sets `isDeleted` flag)

### `PATCH /reports/:id/status`
- Auth roles: `staff`, `supervisor`, `admin`
- Body: `{ status: string, comment?: string }`
- Appends to status history and returns updated report

### `POST /reports/:id/assign`
- Auth roles: `supervisor`, `admin`
- Body: `{ staffId: string, department?: string }`

### `POST /reports/:id/comment`
- Requires bearer token
- Body: `{ text: string, isInternal?: boolean }`
- Returns updated comments array

### `POST /reports/:id/upvote`
- Requires bearer token
- Toggles the authenticated user's upvote state and returns updated report summary

### `POST /reports/:id/feedback`
- Requires bearer token (reporter)
- Body: `{ rating: number (1-5), comment?: string }`

### `POST /reports/:id/media`
- Requires bearer token
- Multipart `media` uploads (up to 5) appended to existing report media

### `DELETE /reports/:id/media/:mediaId`
- Requires bearer token with access rights
- Removes media reference and deletes asset from Cloudinary

### `GET /reports/nearby`
- Query params: `lat`, `lng`, `radius`
- Returns active reports within radius (meters)

### `GET /reports/stats`
- Aggregated counts by status, category, priority, average resolution time

## Admin

Routes are protected by `admin` or `supervisor` roles unless stated otherwise.

### `GET /admin/dashboard`
- Returns `{ stats, recentReports }` where `stats` mirrors cards rendered in the admin dashboard

### `GET /admin/reports/analytics`
- Query: `startDate`, `endDate`, `groupBy` (`hour|day|week|month`)
- Returns timeline counts and category analytics for reporting visualizations

### `GET /admin/users/analytics`
- Returns breakdowns of user counts, growth, verification, and activation stats

### `GET /admin/performance`
- Provides staff and department performance metrics including resolution rates

### `POST /admin/staff/assign-area`
- Role: `admin`
- Body: `{ staffId: string, area: string }`
- Updates staff assignment for routing field work

### `GET /admin/departments`
- Returns list of distinct department strings used in the system

### `POST /admin/departments`
- Role: `admin`
- Body: `{ name, description }`
- Placeholder endpoint; currently echoes payload with success message

## Users

### `GET /users`
- Roles: `admin`, `supervisor`
- Query supports pagination and filter options (email, phone, role, department)

### `GET /users/:id`
- Requires bearer token
- Returns populated user data when caller has access rights

### `PUT /users/:id`
- Role: `admin`
- Allows updating profile, role, department, activation status

### `DELETE /users/:id`
- Role: `admin`
- Soft deletes a user (sets `isDeleted` flag)

### `PUT /users/:id/deactivate` / `PUT /users/:id/activate`
- Role: `admin`
- Toggle user activity flags used by auth middleware

## Error Envelope

Errors are standardized:
```
{
  "success": false,
  "message": "Human readable summary",
  "error": "Optional developer-focused detail"
}
```

Validation errors return `errors: [{ msg, param, location }]` for direct mapping to form field feedback.

## Media Handling

- File upload fields use Multer configuration with 50 MB limit per file
- Accepted types: JPEG, PNG, GIF, MP4, MOV, AVI, PDF
- Files are uploaded to Cloudinary (`civic-backend/middleware/upload.js`), responses reference `secure_url`

## Environment Variables (sanitized)

Clients should source API URLs and secrets from runtime configuration. Reference `civic-backend/.env.example` and `civic-admin/.env.example` for required keys.
